#!/usr/bin/env node

const cli = require('commander');
const glob = require('globby');

require('../lib/hooks');
const runner = require('../lib/runner');
const { description, version } = require('../package.json');
const log = require('../lib/logger');

cli.version(version)
  .description(description)
  .usage('[path]')
  .option('-l, --level <level>', 'Set the log level. Defaults to info')
  .parse(process.argv);

const pattern = cli.args[0] || 'bench/';

const logLevel = cli.level || 'info';
log.setLevel(logLevel);

glob('**/setup.js', { realpath: true })
  .then((paths) => {
    if (paths[0]) {
      log.debug('Generate Setup Suite');
      require(paths[0]); // eslint-disable-line global-require, import/no-dynamic-require
    }
  })
  .then(() => glob([pattern, '!**/setup.js'], { realpath: true }))
  .then((paths) => {
    log.debug('Found test files: {blue:[}{yellow:%s}{blue:]}', paths.toString());
    return paths;
  })
  // eslint-disable-next-line global-require, import/no-dynamic-require
  .then(paths => paths.map(file => require(file)))
  .then(() => runner.run());

